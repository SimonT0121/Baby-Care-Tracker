<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="嬰幼兒照顧追蹤應用 - 幫助父母記錄孩子的成長和日常護理">
    <meta name="theme-color" content="#4285f4">
    <title>Baby Care Tracker</title>
    <link rel="stylesheet" href="./css/styles.css">
    <link rel="./manifest" href="manifest.json">
    <link rel="icon" href="./images/favicon.ico">
    <link rel="apple-touch-icon" href="./images/icon-192x192.png">
</head>
<body>
    <header>
        <div class="container">
            <h1>Baby Care Tracker</h1>
            <nav id="main-nav">
                <button id="menu-toggle" aria-label="菜單">☰</button>
                <ul class="nav-menu">
                    <li><a href="#" data-page="dashboard" class="active">主頁</a></li>
                    <li><a href="#" data-page="children">孩子管理</a></li>
                    <li><a href="#" data-page="activities">日常活動</a></li>
                    <li><a href="#" data-page="health">健康記錄</a></li>
                    <li><a href="#" data-page="milestones">發展里程碑</a></li>
                    <li><a href="#" data-page="stats">統計分析</a></li>
                    <li><a href="#" data-page="settings">設置</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main id="app-container">
        <!-- 當前選中的孩子選擇器 (除了孩子管理頁面外的所有頁面都會顯示) -->
        <div id="child-selector" class="container hidden">
            <select id="current-child">
                <option value="">請選擇孩子</option>
                <!-- 這裡將由JavaScript動態填充 -->
            </select>
        </div>

        <!-- 內容頁面容器 - 由JavaScript動態填充 -->
        <div id="page-container" class="container">
            <!-- Dashboard Page (默認頁面) -->
            <section id="dashboard-page" class="page active">
                <h2>概覽</h2>
                <div id="quick-actions" class="card-container">
                    <div class="card action-card" data-action="feed">
                        <h3>記錄餵食</h3>
                        <p>快速添加餵食記錄</p>
                    </div>
                    <div class="card action-card" data-action="sleep">
                        <h3>記錄睡眠</h3>
                        <p>追蹤寶寶的睡眠</p>
                    </div>
                    <div class="card action-card" data-action="diaper">
                        <h3>記錄尿布</h3>
                        <p>記錄尿布更換</p>
                    </div>
                    <div class="card action-card" data-action="health">
                        <h3>健康記錄</h3>
                        <p>記錄體重、身高等</p>
                    </div>
                </div>
                <div id="daily-summary" class="card">
                    <h3>今日摘要</h3>
                    <div id="today-summary-content">
                        <p>請先選擇一個孩子</p>
                    </div>
                </div>
                <div id="recent-activities" class="card">
                    <h3>最近活動</h3>
                    <div id="recent-activities-list">
                        <!-- 動態填充的活動列表 -->
                    </div>
                </div>
            </section>

            <!-- Children Page -->
            <section id="children-page" class="page">
                <h2>孩子管理</h2>
                <button id="add-child-btn" class="primary-btn">添加孩子</button>
                <div id="children-list" class="card-container">
                    <!-- 動態填充的孩子卡片 -->
                </div>
            </section>

            <!-- Activities Page -->
            <section id="activities-page" class="page">
                <h2>日常活動</h2>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="feed">餵食</button>
                    <button class="tab-btn" data-tab="sleep">睡眠</button>
                    <button class="tab-btn" data-tab="diaper">尿布</button>
                </div>
                <div class="date-selector">
                    <button id="prev-date">&lt;</button>
                    <input type="date" id="activities-date">
                    <button id="next-date">&gt;</button>
                </div>
                <div class="tab-content">
                    <div id="feed-tab" class="tab-pane active">
                        <button id="add-feed-btn" class="action-btn">記錄餵食</button>
                        <div id="feed-list" class="list-container">
                            <!-- 動態填充的餵食記錄 -->
                        </div>
                    </div>
                    <div id="sleep-tab" class="tab-pane">
                        <button id="add-sleep-btn" class="action-btn">記錄睡眠</button>
                        <div id="sleep-list" class="list-container">
                            <!-- 動態填充的睡眠記錄 -->
                        </div>
                    </div>
                    <div id="diaper-tab" class="tab-pane">
                        <button id="add-diaper-btn" class="action-btn">記錄尿布</button>
                        <div id="diaper-list" class="list-container">
                            <!-- 動態填充的尿布記錄 -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Health Page -->
            <section id="health-page" class="page">
                <h2>健康記錄</h2>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="growth">生長記錄</button>
                    <button class="tab-btn" data-tab="checkups">健康訪視</button>
                    <button class="tab-btn" data-tab="vaccines">疫苗記錄</button>
                    <button class="tab-btn" data-tab="medication">用藥記錄</button>
                </div>
                <div class="tab-content">
                    <div id="growth-tab" class="tab-pane active">
                        <button id="add-growth-btn" class="action-btn">添加生長記錄</button>
                        <div id="growth-list" class="list-container">
                            <!-- 動態填充的生長記錄 -->
                        </div>
                    </div>
                    <div id="checkups-tab" class="tab-pane">
                        <button id="add-checkup-btn" class="action-btn">添加健康訪視</button>
                        <div id="checkups-list" class="list-container">
                            <!-- 動態填充的健康訪視記錄 -->
                        </div>
                    </div>
                    <div id="vaccines-tab" class="tab-pane">
                        <button id="add-vaccine-btn" class="action-btn">添加疫苗記錄</button>
                        <div id="vaccines-list" class="list-container">
                            <!-- 動態填充的疫苗記錄 -->
                        </div>
                    </div>
                    <div id="medication-tab" class="tab-pane">
                        <button id="add-medication-btn" class="action-btn">添加用藥記錄</button>
                        <div id="medication-list" class="list-container">
                            <!-- 動態填充的用藥記錄 -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Milestones Page -->
            <section id="milestones-page" class="page">
                <h2>發展里程碑</h2>
                <div class="milestone-categories">
                    <button class="milestone-category active" data-category="all">全部</button>
                    <button class="milestone-category" data-category="motor">動作技能</button>
                    <button class="milestone-category" data-category="language">語言能力</button>
                    <button class="milestone-category" data-category="social">社交情感</button>
                    <button class="milestone-category" data-category="cognitive">認知能力</button>
                </div>
                <div id="milestones-list" class="card-container">
                    <!-- 動態填充的里程碑卡片 -->
                </div>
            </section>

            <!-- Stats Page -->
            <section id="stats-page" class="page">
                <h2>統計分析</h2>
                <div class="stats-period-selector">
                    <button class="period-btn active" data-period="week">週</button>
                    <button class="period-btn" data-period="month">月</button>
                    <button class="period-btn" data-period="custom">自定義</button>
                </div>
                <div id="custom-period" class="hidden">
                    <label for="stats-start-date">開始日期:</label>
                    <input type="date" id="stats-start-date">
                    <label for="stats-end-date">結束日期:</label>
                    <input type="date" id="stats-end-date">
                    <button id="apply-custom-period" class="secondary-btn">應用</button>
                </div>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="feeding-stats">餵食</button>
                    <button class="tab-btn" data-tab="sleep-stats">睡眠</button>
                    <button class="tab-btn" data-tab="diaper-stats">尿布</button>
                    <button class="tab-btn" data-tab="growth-stats">生長</button>
                </div>
                <div class="tab-content">
                    <div id="feeding-stats-tab" class="tab-pane active">
                        <div class="chart-container">
                            <canvas id="feeding-chart"></canvas>
                        </div>
                        <div id="feeding-summary" class="stats-summary">
                            <!-- 動態填充的餵食統計摘要 -->
                        </div>
                    </div>
                    <div id="sleep-stats-tab" class="tab-pane">
                        <div class="chart-container">
                            <canvas id="sleep-chart"></canvas>
                        </div>
                        <div id="sleep-summary" class="stats-summary">
                            <!-- 動態填充的睡眠統計摘要 -->
                        </div>
                    </div>
                    <div id="diaper-stats-tab" class="tab-pane">
                        <div class="chart-container">
                            <canvas id="diaper-chart"></canvas>
                        </div>
                        <div id="diaper-summary" class="stats-summary">
                            <!-- 動態填充的尿布統計摘要 -->
                        </div>
                    </div>
                    <div id="growth-stats-tab" class="tab-pane">
                        <div class="chart-container">
                            <canvas id="growth-chart"></canvas>
                        </div>
                        <div id="growth-summary" class="stats-summary">
                            <!-- 動態填充的生長統計摘要 -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Page -->
            <section id="settings-page" class="page">
                <h2>設置</h2>
                <div class="settings-group">
                    <h3>應用設置</h3>
                    <div class="setting-item">
                        <label for="theme-selector">主題:</label>
                        <select id="theme-selector">
                            <option value="light">淺色</option>
                            <option value="dark">深色</option>
                            <option value="system">跟隨系統</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="language-selector">語言:</label>
                        <select id="language-selector">
                            <option value="zh-TW">繁體中文</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="data-retention">數據保留期限:</label>
                        <select id="data-retention">
                            <option value="1">1 年</option>
                            <option value="2">2 年</option>
                            <option value="3">3 年</option>
                            <option value="0">永久保留</option>
                        </select>
                    </div>
                </div>
                <div class="settings-group">
                    <h3>數據管理</h3>
                    <button id="backup-data-btn" class="secondary-btn">備份數據</button>
                    <button id="restore-data-btn" class="secondary-btn">還原數據</button>
                    <button id="clear-data-btn" class="danger-btn">清除所有數據</button>
                </div>
            </section>
        </div>
    </main>

    <!-- 模態對話框 (各種表單) -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <div id="modal-container" class="modal-container">
            <div class="modal-header">
                <h3 id="modal-title">標題</h3>
                <button id="close-modal" class="close-btn">&times;</button>
            </div>
            <div id="modal-content" class="modal-content">
                <!-- 模態內容將由JavaScript動態填充 -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Baby Care Tracker</p>
            <p id="version">版本 1.0.0</p>
        </div>
    </footer>

    <!-- 離線提示 -->
    <div id="offline-notification" class="notification hidden">
        您現在處於離線狀態。部分功能可能不可用。
    </div>

    <!-- 通用提示訊息 -->
    <div id="toast-container" class="toast-container"></div>

<!-- 載入JavaScript文件 -->
    <script src="./js/utils.js"></script>
    <script src="./js/db.js"></script>
    <script src="./js/services/childService.js"></script>
    <script src="./js/services/activityService.js"></script>
    <script src="./js/services/healthService.js"></script>
    <script src="./js/services/milestoneService.js"></script>
    <script src="./js/views/childView.js"></script>
    <script src="./js/views/activityView.js"></script>
    <script src="./js/views/healthView.js"></script>
    <script src="./js/views/milestoneView.js"></script>
    <script src="./js/views/statsView.js"></script>
    <script src="./js/views/settingsView.js"></script>
    <script src="./js/app.js"></script>
    <script src="./js/libs/chart.min.js"></script>

    <!-- 註冊Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker 註冊成功:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker 註冊失敗:', error);
                    });
            });
        }
    </script>

        <script>
        // 直接在頁面上定義里程碑初始化功能
        (function() {
            // 確保只在需要的服務存在時運行
            if (!window.MilestoneService || !window.Database || !window.ChildService) {
                console.error('必要的服務未加載!');
                return;
            }

            // 添加里程碑初始化方法 (確保方法存在)
            MilestoneService.initializeStandardMilestones = async function(childId) {
                try {
                    console.log(`開始初始化標準里程碑: childId=${childId}`);
                    if (window.AppLog) window.AppLog.addLog(`開始初始化標準里程碑: childId=${childId}`);

                    // 檢查孩子是否存在
                    const child = await ChildService.getChildById(childId);
                    if (!child) {
                        const error = new Error(`找不到ID為 ${childId} 的孩子`);
                        if (window.AppLog) window.AppLog.addLog(`初始化里程碑錯誤: ${error.message}`);
                        throw error;
                    }

                    // 檢查是否已有里程碑記錄
                    const existingMilestones = await Database.getByIndex('milestones', 'childId', childId);
                    if (existingMilestones.length > 0) {
                        console.log(`孩子已有 ${existingMilestones.length} 個里程碑記錄，跳過初始化`);
                        if (window.AppLog) window.AppLog.addLog(`孩子已有 ${existingMilestones.length} 個里程碑記錄，跳過初始化`);
                        return true; // 已有記錄，不需要初始化
                    }

                    // 獲取標準里程碑列表
                    const standardMilestones = MilestoneService.getStandardMilestones(); // 假設此方法已在 MilestoneService 中定義
                    if (!standardMilestones || standardMilestones.length === 0) {
                        console.warn('未獲取到標準里程碑列表或列表為空，無法初始化。');
                        if (window.AppLog) window.AppLog.addLog('未獲取到標準里程碑列表或列表為空，無法初始化。');
                        return false;
                    }
                    console.log(`準備初始化 ${standardMilestones.length} 個標準里程碑`);
                    if (window.AppLog) window.AppLog.addLog(`準備初始化 ${standardMilestones.length} 個標準里程碑`);

                    // 為每個標準里程碑創建記錄
                    let createdCount = 0;
                    for (const milestone of standardMilestones) {
                        try {
                            // 創建未達成的空記錄
                            const milestoneData = {
                                childId: childId,
                                name: milestone.name,
                                category: milestone.category,
                                ageMonthRecommended: milestone.ageMonthRecommended,
                                achievedDate: null, // 未達成
                                note: '',
                                createdAt: new Date(),
                                updatedAt: new Date()
                            };

                            await Database.add('milestones', milestoneData);
                            createdCount++;
                        } catch (addError) {
                            console.error(`添加里程碑 ${milestone.name} 失敗:`, addError);
                            // 繼續處理其他里程碑
                        }
                    }

                    console.log(`標準里程碑初始化完成: 創建了 ${createdCount} 個記錄`);
                    if (window.AppLog) window.AppLog.addLog(`標準里程碑初始化完成: 創建了 ${createdCount} 個記錄`);
                    return true;
                } catch (error) {
                    console.error(`為孩子 ${childId} 初始化標準里程碑失敗:`, error);
                    if (window.AppLog) window.AppLog.addLog(`初始化標準里程碑失敗: ${error.message}`);
                    throw error;
                }
            };

            // 添加初始化按鈕到 "發展里程碑" 頁面
            function addInitButtonToMilestonesPage() {
                // 確保不重複添加
                if (document.getElementById('initMilestonesBtn')) return;

                const milestonesPageSection = document.getElementById('milestones-page');
                if (!milestonesPageSection) {
                    console.warn('找不到 "發展里程碑" 頁面 (id="milestones-page")，無法添加初始化按鈕。');
                    return;
                }

                const btn = document.createElement('button');
                btn.id = 'initMilestonesBtn';
                btn.innerText = '初始化里程碑數據';
                // 更新按鈕樣式，使其適合在 section 內部顯示
                btn.style.padding = '10px 15px';
                btn.style.backgroundColor = '#28a745'; // 綠色，表示積極操作
                btn.style.color = 'white';
                btn.style.border = 'none';
                btn.style.borderRadius = '4px';
                btn.style.margin = '15px 0'; // 在列表上方或下方留出一些空間
                btn.style.cursor = 'pointer';
                // btn.style.display = 'block'; // 如果希望按鈕獨占一行
                // btn.style.marginLeft = 'auto'; // 如果希望按鈕靠右 (需要父容器配合或 display:block)
                // btn.style.marginRight = 'auto';

                btn.onclick = async function() {
                    try {
                        btn.disabled = true;
                        btn.innerText = '初始化中...';
                        btn.style.backgroundColor = '#6c757d'; // 禁用時的顏色

                        const currentChild = await ChildService.getCurrentChild();
                        if (currentChild) {
                            if (window.AppLog) window.AppLog.addLog(`開始為孩子 ${currentChild.name} 初始化里程碑`);
                            const success = await MilestoneService.initializeStandardMilestones(currentChild.id);

                            if (success) {
                                const milestones = await Database.getByIndex('milestones', 'childId', currentChild.id);
                                if (window.AppLog) window.AppLog.addLog(`初始化后里程碑數量: ${milestones.length}`);
                                alert(`里程碑初始化成功！已創建/確認 ${milestones.length} 個里程碑記錄。請刷新里程碑列表查看。`);

                                // 考慮是否自動刷新里程碑視圖而不是整個頁面
                                // 例如，如果 MilestoneView 有一個渲染方法：
                                // if (window.MilestoneView && typeof window.MilestoneView.renderMilestonesForCurrentChild === 'function') {
                                //     await window.MilestoneView.renderMilestonesForCurrentChild();
                                // } else {
                                //     location.reload(); // 作為後備
                                // }
                                // 暫時先用提示用戶刷新，或直接刷新頁面
                                if (confirm("里程碑已初始化，是否刷新頁面查看最新數據？")) {
                                    location.reload();
                                }

                            } else {
                                alert('里程碑可能已經初始化過，或未找到標準里程碑數據。');
                            }
                        } else {
                            alert('未找到當前孩子，請先選擇一個孩子。');
                        }
                    } catch (error) {
                        alert('初始化失敗: ' + error.message);
                        console.error('初始化失敗:', error);
                    } finally {
                        btn.disabled = false;
                        btn.innerText = '初始化里程碑數據';
                        btn.style.backgroundColor = '#28a745'; // 恢復原色
                    }
                };

                // 將按鈕添加到 "發展里程碑" 頁面的末尾，或者其他你認為合適的位置
                // 例如，添加到 milestones-list 的前面或後面
                const milestonesListContainer = milestonesPageSection.querySelector('#milestones-list');
                if (milestonesListContainer) {
                    // 在里程碑列表前添加按鈕
                    milestonesListContainer.parentNode.insertBefore(btn, milestonesListContainer);
                } else {
                    // 如果列表容器不存在，直接添加到 section 末尾
                    milestonesPageSection.appendChild(btn);
                }
                console.log('初始化里程碑數據按鈕已添加到發展里程碑頁面。');
                 if (window.AppLog) window.AppLog.addLog('初始化里程碑數據按鈕已添加到發展里程碑頁面。');
            }

            // 等待DOM完全加載後添加按鈕
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', addInitButtonToMilestonesPage);
            } else {
                // DOMContentLoaded 已經觸發
                addInitButtonToMilestonesPage();
            }

            console.log('里程碑初始化功能已準備');
            if (window.AppLog) window.AppLog.addLog('里程碑初始化功能已準備');
        })();
    </script>
</body>
</html>
